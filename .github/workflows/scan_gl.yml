name: Gitleaks
on:
    # pull_request:
    # push:
    # workflow_dispatch: 
    # schedule:
        # run every SUN
        # - cron: "0 0 * * SUN"
        # run every month
        #  - cron: "0 0 1 * *"
    workflow_call:
jobs:
    scan:
        name: Gitleaks
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4.1.2
              with:
                  fetch-depth: 0

            - name: Download patterns file
              env:
                  TOKEN: ${{ secrets.GITLEAKS_TOKEN }}
              # from practical point of view, leaks are regex without any secrets and no harm to put in pulbic repo, 
              # but proper solution is more interesting with correctly protected files
              run: >
                  curl -H "Authorization: token ${TOKEN}" 
                  --create-dirs -O --output-dir /tmp/configs/scan_gl/
                  --fail-with-body
                  https://raw.githubusercontent.com/halt9k/shared-workflows-private/main/configs/scan_gl/gitleaks.toml
                
            - name: Check file existence
              id: check_files
              uses: andstor/file-existence-action@v3.0.0
              with:
                  files: "/tmp/configs/scan_gl/gitleaks.toml"
            
            #- name: If file exists
            #  if: steps.check_files.outputs.files_exists == 'true'
            #  run: echo "It exists !"

            - uses: gitleaks/gitleaks-action@v2.3.4
              env:
                  # GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  # Only required for Organizations, not personal accounts.
                  GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE}}
                  GITLEAKS_CONFIG: /tmp/configs/scan_gl/gitleaks.toml

            - name: Commitsar conventional commits check
              env:
                  COMMITSAR_CONFIG_PATH: ./configs
              uses: aevea/commitsar@v0.20.2